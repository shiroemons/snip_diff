import React, { useEffect, useRef, useState, forwardRef, useImperativeHandle } from 'react';
import { DiffEditor as MonacoDiffEditor, Editor as MonacoEditor, loader } from '@monaco-editor/react';
import { useDiffStore } from '../../stores/diffStore';
import type { editor } from 'monaco-editor';
import * as monaco from 'monaco-editor';
import './DiffEditor.css';

// Monaco Editor „ÅÆ„É≠„Éº„ÉÄ„ÉºË®≠ÂÆö - „É≠„Éº„Ç´„É´„Åã„ÇâË™≠„ÅøËæº„Åø
loader.config({ monaco });

export interface DiffEditorRef {
  compare: () => void;
  swap: () => void;
  clear: () => void;
}

interface DiffEditorProps {
  theme?: 'light' | 'dark';
}

const DiffEditor = forwardRef<DiffEditorRef, DiffEditorProps>(({ theme = 'dark' }, ref) => {
  const { getActiveSession, updateStats } = useDiffStore();
  const activeSession = getActiveSession();
  const diffEditorRef = useRef<editor.IStandaloneDiffEditor | null>(null);
  const leftEditorRef = useRef<editor.IStandaloneCodeEditor | null>(null);
  const rightEditorRef = useRef<editor.IStandaloneCodeEditor | null>(null);
  const [showComparePanel, setShowComparePanel] = useState(true);
  const [leftContent, setLeftContent] = useState('');
  const [rightContent, setRightContent] = useState('');
  const [comparePanelHeight, setComparePanelHeight] = useState(350);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [isResizing, setIsResizing] = useState(false);
  const [isMinimized, setIsMinimized] = useState(false);
  const dragStartRef = useRef<{ y: number; height: number } | null>(null);
  const lastHeightRef = useRef<number>(350);

  // store„Åã„ÇâË®ÄË™û„ÇíÂèñÂæó
  const language = activeSession?.left.lang || 'plaintext';

  // ÊØîËºÉ„ÇíÂÆüË°å„Åô„ÇãÈñ¢Êï∞
  const handleCompare = () => {
    const leftValue = leftEditorRef.current?.getValue() || '';
    const rightValue = rightEditorRef.current?.getValue() || '';

    setLeftContent(leftValue);
    setRightContent(rightValue);

    // Áµ±Ë®à„ÇíË®àÁÆó
    const leftLines = leftValue.split('\n').length;
    const rightLines = rightValue.split('\n').length;

    updateStats({
      adds: Math.max(0, rightLines - leftLines),
      dels: Math.max(0, leftLines - rightLines),
      hunks: 1,
      leftLines,
      rightLines,
    });

    // ÊØîËºÉ„Éë„Éç„É´„ÇíË°®Á§∫
    setShowComparePanel(true);
  };

  // ÂÖ®ÁîªÈù¢Ë°®Á§∫„ÅÆÂàá„ÇäÊõø„Åà
  const handleToggleFullscreen = () => {
    setIsFullscreen(!isFullscreen);
  };

  // ÊúÄÂ∞èÂåñ„ÅÆÂàá„ÇäÊõø„Åà
  const handleToggleMinimize = () => {
    if (isMinimized) {
      // Âæ©ÂÖÉ
      setComparePanelHeight(lastHeightRef.current);
      setIsMinimized(false);
    } else {
      // ÊúÄÂ∞èÂåñ
      lastHeightRef.current = comparePanelHeight;
      setIsMinimized(true);
    }
  };

  // Â∑¶Âè≥„ÇíÂÖ•„ÇåÊõø„Åà
  const handleSwap = () => {
    const leftValue = leftEditorRef.current?.getValue() || '';
    const rightValue = rightEditorRef.current?.getValue() || '';

    leftEditorRef.current?.setValue(rightValue);
    rightEditorRef.current?.setValue(leftValue);
  };

  // „ÇØ„É™„Ç¢
  const handleClear = () => {
    leftEditorRef.current?.setValue('');
    rightEditorRef.current?.setValue('');

    setLeftContent('');
    setRightContent('');

    updateStats({
      adds: 0,
      dels: 0,
      hunks: 0,
      leftLines: 0,
      rightLines: 0,
    });
  };

  // Â∑¶„Ç®„Éá„Ç£„Çø„Å´Ë≤º„Çä‰ªò„Åë
  const handlePasteLeft = async () => {
    if (!window.electron) return;
    try {
      const text = await window.electron.clipboard.read();
      leftEditorRef.current?.setValue(text);
    } catch (error) {
      console.error('Failed to paste to left editor:', error);
    }
  };

  // Âè≥„Ç®„Éá„Ç£„Çø„Å´Ë≤º„Çä‰ªò„Åë
  const handlePasteRight = async () => {
    if (!window.electron) return;
    try {
      const text = await window.electron.clipboard.read();
      rightEditorRef.current?.setValue(text);
    } catch (error) {
      console.error('Failed to paste to right editor:', error);
    }
  };

  // Â∑¶„Ç®„Éá„Ç£„Çø„Çí„ÇØ„É™„Ç¢
  const handleClearLeft = () => {
    leftEditorRef.current?.setValue('');
  };

  // Âè≥„Ç®„Éá„Ç£„Çø„Çí„ÇØ„É™„Ç¢
  const handleClearRight = () => {
    rightEditorRef.current?.setValue('');
  };

  // „É™„Çµ„Ç§„Ç∫„Éè„É≥„Éâ„É´„ÅÆ„Éû„Ç¶„Çπ„ÉÄ„Ç¶„É≥
  const handleResizeMouseDown = (e: React.MouseEvent) => {
    e.preventDefault();
    dragStartRef.current = {
      y: e.clientY,
      height: comparePanelHeight,
    };
    setIsResizing(true);
    document.body.classList.add('resizing-panel');
  };

  // „É™„Çµ„Ç§„Ç∫‰∏≠„ÅÆ„Éû„Ç¶„ÇπÁßªÂãïÂá¶ÁêÜ
  useEffect(() => {
    if (!isResizing || !dragStartRef.current) return;

    let animationFrameId: number | null = null;

    const handleMouseMove = (e: MouseEvent) => {
      if (!dragStartRef.current) return;

      if (animationFrameId !== null) {
        cancelAnimationFrame(animationFrameId);
      }

      animationFrameId = requestAnimationFrame(() => {
        if (!dragStartRef.current) return;

        const deltaY = dragStartRef.current.y - e.clientY;
        const newHeight = dragStartRef.current.height + deltaY;

        const containerHeight = window.innerHeight - 100; // „Éò„ÉÉ„ÉÄ„Éº„Å®„Éï„ÉÉ„Çø„Éº„ÇíÈô§„Åè
        // ÊúÄÂ∞è200px„ÄÅÊúÄÂ§ß80%„Å´Âà∂Èôê
        const minHeight = 200;
        const maxHeight = containerHeight * 0.8;
        const clampedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

        setComparePanelHeight(clampedHeight);
      });
    };

    const handleMouseUp = () => {
      setIsResizing(false);
      dragStartRef.current = null;
      document.body.classList.remove('resizing-panel');
      if (animationFrameId !== null) {
        cancelAnimationFrame(animationFrameId);
      }
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
      document.body.classList.remove('resizing-panel');
      if (animationFrameId !== null) {
        cancelAnimationFrame(animationFrameId);
      }
    };
  }, [isResizing]);

  // Â§ñÈÉ®„Åã„ÇâÂëº„Å≥Âá∫„Åõ„Çã„Çà„ÅÜ„Å´„É°„ÇΩ„ÉÉ„Éâ„ÇíÂÖ¨Èñã
  useImperativeHandle(ref, () => ({
    compare: handleCompare,
    swap: handleSwap,
    clear: handleClear,
  }));

  // Â∑¶„Ç®„Éá„Ç£„Çø„ÅÆ„Éû„Ç¶„É≥„ÉàÂá¶ÁêÜ
  const handleLeftEditorDidMount = (editor: editor.IStandaloneCodeEditor) => {
    leftEditorRef.current = editor;

    // ÂÜÖÂÆπ„ÅåÂ§âÊõ¥„Åï„Çå„Åü„ÇâÂç≥Â∫ß„Å´Â∑ÆÂàÜ„ÇíÊõ¥Êñ∞
    editor.onDidChangeModelContent(() => {
      const leftValue = editor.getValue();
      const rightValue = rightEditorRef.current?.getValue() || '';

      setLeftContent(leftValue);

      // Áµ±Ë®à„ÇíÊõ¥Êñ∞
      const leftLines = leftValue.split('\n').length;
      const rightLines = rightValue.split('\n').length;

      updateStats({
        adds: Math.max(0, rightLines - leftLines),
        dels: Math.max(0, leftLines - rightLines),
        hunks: 1,
        leftLines,
        rightLines,
      });
    });
  };

  // Âè≥„Ç®„Éá„Ç£„Çø„ÅÆ„Éû„Ç¶„É≥„ÉàÂá¶ÁêÜ
  const handleRightEditorDidMount = (editor: editor.IStandaloneCodeEditor) => {
    rightEditorRef.current = editor;

    // ÂÜÖÂÆπ„ÅåÂ§âÊõ¥„Åï„Çå„Åü„ÇâÂç≥Â∫ß„Å´Â∑ÆÂàÜ„ÇíÊõ¥Êñ∞
    editor.onDidChangeModelContent(() => {
      const leftValue = leftEditorRef.current?.getValue() || '';
      const rightValue = editor.getValue();

      setRightContent(rightValue);

      // Áµ±Ë®à„ÇíÊõ¥Êñ∞
      const leftLines = leftValue.split('\n').length;
      const rightLines = rightValue.split('\n').length;

      updateStats({
        adds: Math.max(0, rightLines - leftLines),
        dels: Math.max(0, leftLines - rightLines),
        hunks: 1,
        leftLines,
        rightLines,
      });
    });
  };

  // Diff„Ç®„Éá„Ç£„Çø„ÅÆ„Éû„Ç¶„É≥„ÉàÂá¶ÁêÜ
  const handleDiffEditorDidMount = (editor: editor.IStandaloneDiffEditor) => {
    diffEditorRef.current = editor;
  };

  // ÂÖ±ÈÄö„Ç®„Éá„Ç£„Çø„Ç™„Éó„Ç∑„Éß„É≥
  const commonEditorOptions: editor.IStandaloneEditorConstructionOptions = {
    minimap: { enabled: true },
    scrollbar: {
      vertical: 'visible',
      horizontal: 'visible',
      useShadows: false,
    },
    lineNumbers: 'on',
    glyphMargin: true,
    folding: true,
    wordWrap: activeSession?.options.wordWrap ? 'on' : 'off',
    fontSize: activeSession?.options.fontSize ?? 14,
    tabSize: activeSession?.options.tabSize ?? 4,
    insertSpaces: activeSession?.options.insertSpaces ?? true,
    automaticLayout: true,
  };


  if (!activeSession) {
    return (
      <div className="diff-editor-container">
        <div className="no-session">„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>
      </div>
    );
  }

  return (
    <div className="diff-editor-container">
      {/* ‰∏äÈÉ®: ÂÖ•Âäõ„Ç®„Éá„Ç£„Çø */}
      <div
        className={`input-editor-section ${isResizing ? 'resizing' : ''}`}
        style={{
          height: showComparePanel
            ? isMinimized
              ? 'calc(100% - 40px)'
              : `calc(100% - ${comparePanelHeight}px)`
            : '100%',
        }}
      >
        <div className="editor-labels">
          <div className="editor-label editor-label-left">
            <span className="editor-label-text">Before</span>
            <div className="editor-label-actions">
              <button
                className="editor-label-button"
                onClick={handlePasteLeft}
                title="„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË≤º„Çä‰ªò„Åë (‚åòV)"
              >
                üìã
              </button>
              <button
                className="editor-label-button"
                onClick={handleClearLeft}
                title="„ÇØ„É™„Ç¢"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
          <div className="editor-label editor-label-right">
            <span className="editor-label-text">After</span>
            <div className="editor-label-actions">
              <button
                className="editor-label-button"
                onClick={handlePasteRight}
                title="„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË≤º„Çä‰ªò„Åë (‚åòV)"
              >
                üìã
              </button>
              <button
                className="editor-label-button"
                onClick={handleClearRight}
                title="„ÇØ„É™„Ç¢"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
        <div className="dual-editor-container">
          <div className="editor-pane">
            <MonacoEditor
              defaultValue={leftContent}
              language={language}
              theme={theme === 'light' ? 'vs' : 'vs-dark'}
              onMount={handleLeftEditorDidMount}
              options={commonEditorOptions}
            />
          </div>
          <div className="editor-divider"></div>
          <div className="editor-pane">
            <MonacoEditor
              defaultValue={rightContent}
              language={language}
              theme={theme === 'light' ? 'vs' : 'vs-dark'}
              onMount={handleRightEditorDidMount}
              options={commonEditorOptions}
            />
          </div>
        </div>
      </div>

      {/* ‰∏ãÈÉ®: ÊØîËºÉ„Éë„Éç„É´ */}
      {showComparePanel && (
        <div
          className={`compare-panel ${isFullscreen ? 'fullscreen' : ''} ${isMinimized ? 'minimized' : ''} ${isResizing ? 'resizing' : ''}`}
          style={{ height: isFullscreen ? '100%' : isMinimized ? '40px' : `${comparePanelHeight}px` }}
        >
          {/* „É™„Çµ„Ç§„Ç∫„Éè„É≥„Éâ„É´ */}
          {!isFullscreen && !isMinimized && (
            <div
              className={`resize-handle ${isResizing ? 'resizing' : ''}`}
              onMouseDown={handleResizeMouseDown}
            >
              <div className="resize-handle-bar" />
            </div>
          )}

          <div className="compare-panel-header">
            <span className="compare-panel-title">Â∑ÆÂàÜË°®Á§∫</span>
            <div className="compare-panel-controls">
              {/* „Éì„É•„Éº„É¢„Éº„ÉâÂàáÊõø */}
              <div className="view-mode-toggle">
                <button
                  className={activeSession?.options.viewMode === 'unified' ? 'active' : ''}
                  onClick={() => useDiffStore.getState().updateOptions({ viewMode: 'unified' })}
                  title="Unified (‚åò1)"
                >
                  Unified
                </button>
                <button
                  className={activeSession?.options.viewMode === 'side-by-side' ? 'active' : ''}
                  onClick={() => useDiffStore.getState().updateOptions({ viewMode: 'side-by-side' })}
                  title="Side by Side (‚åò2)"
                >
                  Side by Side
                </button>
              </div>
              <div className="compare-panel-actions">
                <button
                  className="panel-action-button"
                  onClick={handleToggleMinimize}
                  title={isMinimized ? '„Éë„Éç„É´„ÇíÂæ©ÂÖÉ' : '„Éë„Éç„É´„ÇíÊúÄÂ∞èÂåñ'}
                >
                  {isMinimized ? '‚ñ≤' : '‚ñº'}
                </button>
                <button
                  className="panel-action-button"
                  onClick={handleToggleFullscreen}
                  title={isFullscreen ? 'ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫„Å´Êàª„Åô' : 'ÂÖ®ÁîªÈù¢Ë°®Á§∫'}
                >
                  {isFullscreen ? '‚ä°' : '‚õ∂'}
                </button>
              </div>
            </div>
          </div>
          {!isMinimized && (
            <div className="compare-panel-content">
              <MonacoDiffEditor
                original={leftContent}
                modified={rightContent}
                language={language}
                theme={theme === 'light' ? 'vs' : 'vs-dark'}
                onMount={handleDiffEditorDidMount}
                options={{
                  readOnly: true,
                  renderSideBySide: activeSession?.options.viewMode === 'side-by-side',
                  ignoreTrimWhitespace: activeSession?.options.ignoreWhitespace ?? false,
                  originalEditable: false,
                  automaticLayout: true,
                  fontSize: activeSession?.options.fontSize ?? 14,
                } as editor.IDiffEditorConstructionOptions}
              />
            </div>
          )}
        </div>
      )}
    </div>
  );
});

DiffEditor.displayName = 'DiffEditor';

export default DiffEditor;
